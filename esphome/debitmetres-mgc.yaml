
# ============================================================
#  Projet : DÃ©bitmÃ¨tres Eau ESP32 â€“ ESPHome
#  Auteur : Portos330D (JÃ©rÃ©my)
#  Version : 1.0 â€“ 2025
#  Licence : MIT
#  Description :
#     Mesure et suivi de la consommation dâ€™eau (Maison / Garage / Cumulus)
#     via des dÃ©bitmÃ¨tres YF-B5 / YF-B6 / YF-S201.
# ============================================================

esphome:
  name: debitmetres-eau
  friendly_name: DÃ©bitmÃ¨tres Eau Maison / Garage / Cumulus

esp32:
  board: esp32dev
  framework:
    type: esp-idf

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none
  fast_connect: true

logger:
api:
ota:
  platform: esphome

# ======================================================
# ğŸ”§ Calibration impulsions/Litre
# ======================================================
number:
  - platform: template
    name: "Impulsions/Litre Eau Maison"
    id: ppl_maison
    unique_id: calib_eau_maison
    optimistic: true
    min_value: 200
    max_value: 800
    step: 1
    restore_value: true
    initial_value: 313
    unit_of_measurement: "pulses/L"

  - platform: template
    name: "Impulsions/Litre Eau Garage"
    id: ppl_garage
    unique_id: calib_eau_garage
    optimistic: true
    min_value: 200
    max_value: 800
    step: 1
    restore_value: true
    initial_value: 313
    unit_of_measurement: "pulses/L"

  - platform: template
    name: "Impulsions/Litre Eau Cumulus"
    id: ppl_cumulus
    unique_id: calib_eau_cumulus
    optimistic: true
    min_value: 200
    max_value: 800
    step: 1
    restore_value: true
    initial_value: 664
    unit_of_measurement: "pulses/L"

# ======================================================
# ğŸ’§ Capteurs bruts (impulsions)
# ======================================================
sensor:
  # --- Eau Maison ---
  - platform: pulse_meter
    id: pulse_maison
    unique_id: pulse_maison_raw
    pin:
      number: GPIO13
      mode: INPUT_PULLUP
    name: "DÃ©bitmÃ¨tre Eau Maison (pulses/min)"
    internal_filter: 100us
    accuracy_decimals: 0
    timeout: 5s
    total:
      id: pulse_maison_total
      unique_id: pulse_maison_total
      name: "Volume Eau Maison brut"
      unit_of_measurement: "pulses"
      accuracy_decimals: 0
    filters:
      - multiply: 1.0

  # --- Eau Garage ---
  - platform: pulse_meter
    id: pulse_garage
    unique_id: pulse_garage_raw
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
    name: "DÃ©bitmÃ¨tre Eau Garage (pulses/min)"
    internal_filter: 100us
    accuracy_decimals: 0
    timeout: 5s
    total:
      id: pulse_garage_total
      unique_id: pulse_garage_total
      name: "Volume Eau Garage brut"
      unit_of_measurement: "pulses"
      accuracy_decimals: 0
    filters:
      - multiply: 1.0

  # --- Eau Cumulus ---
  - platform: pulse_meter
    id: pulse_cumulus
    unique_id: pulse_cumulus_raw
    pin:
      number: GPIO19
      mode: INPUT_PULLUP
    name: "DÃ©bitmÃ¨tre Eau Cumulus (pulses/min)"
    internal_filter: 100us
    accuracy_decimals: 0
    timeout: 5s
    total:
      id: pulse_cumulus_total
      unique_id: pulse_cumulus_total
      name: "Volume Eau Cumulus brut"
      unit_of_measurement: "pulses"
      accuracy_decimals: 0
    filters:
      - multiply: 1.0

# ======================================================
# âš™ï¸ DÃ©bits calculÃ©s L/min (stables)
# ======================================================
  - platform: template
    name: "DÃ©bit Eau Maison (L/min)"
    id: debit_maison
    unique_id: debit_eau_maison
    unit_of_measurement: "L/min"
    accuracy_decimals: 2
    update_interval: 3s
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1
    lambda: |-
      if (id(pulse_maison).state > 0 && id(ppl_maison).state > 0) {
        return id(pulse_maison).state / id(ppl_maison).state;
      } else {
        return 0;
      }

  - platform: template
    name: "DÃ©bit Eau Garage (L/min)"
    id: debit_garage
    unique_id: debit_eau_garage
    unit_of_measurement: "L/min"
    accuracy_decimals: 2
    update_interval: 3s
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1
    lambda: |-
      if (id(pulse_garage).state > 0 && id(ppl_garage).state > 0) {
        return id(pulse_garage).state / id(ppl_garage).state;
      } else {
        return 0;
      }

  - platform: template
    name: "DÃ©bit Eau Cumulus (L/min)"
    id: debit_cumulus
    unique_id: debit_eau_cumulus
    unit_of_measurement: "L/min"
    accuracy_decimals: 2
    update_interval: 3s
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1
    lambda: |-
      if (id(pulse_cumulus).state > 0 && id(ppl_cumulus).state > 0) {
        return id(pulse_cumulus).state / id(ppl_cumulus).state;
      } else {
        return 0;
      }

# ======================================================
# ğŸ“Š Volumes totaux calculÃ©s
# ======================================================
  - platform: template
    name: "Volume Eau Maison (L)"
    id: volume_maison
    unique_id: volume_eau_maison
    unit_of_measurement: "L"
    accuracy_decimals: 2
    lambda: |-
      if (id(ppl_maison).state > 0) {
        return id(pulse_maison_total).state / id(ppl_maison).state;
      } else {
        return 0;
      }

  - platform: template
    name: "Volume Eau Garage (L)"
    id: volume_garage
    unique_id: volume_eau_garage
    unit_of_measurement: "L"
    accuracy_decimals: 2
    lambda: |-
      if (id(ppl_garage).state > 0) {
        return id(pulse_garage_total).state / id(ppl_garage).state;
      } else {
        return 0;
      }

  - platform: template
    name: "Volume Eau Cumulus (L)"
    id: volume_cumulus
    unique_id: volume_eau_cumulus
    unit_of_measurement: "L"
    accuracy_decimals: 2
    lambda: |-
      if (id(ppl_cumulus).state > 0) {
        return id(pulse_cumulus_total).state / id(ppl_cumulus).state;
      } else {
        return 0;
      }

# ======================================================
# ğŸ” Bouton Reset total
# ======================================================
button:
  - platform: template
    name: "ğŸ” RÃ©initialiser Volumes DÃ©bitmÃ¨tres"
    unique_id: reset_volumes_debitmetres
    on_press:
      - lambda: |-
          id(pulse_maison_total).publish_state(0);
          id(pulse_garage_total).publish_state(0);
          id(pulse_cumulus_total).publish_state(0);
